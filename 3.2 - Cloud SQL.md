# 1. Utworzenie Cloud PostgreSQL

- W celu utworzenia CloudSQL wpisz w wyszukiwarkę GCP frazę *"SQL"*. 
Powinieneś otrzymać **Usługa SQL**, następnie wybierz ją.

- W kolejnym kroku zobaczysz ekran powitalny, poprostu wybierz **UTWÓRZ INSTANCJĘ**.

- Poterm z dostępnych mechanizmów baz danych wybierz **PostgreSQL**.

- W formularzu **Tworzenia instancji PostgreSQL** wprowadź dane z poniższego wzoru:<br />

    Instance ID: **flights**<br />
    Password: **Generate** lub wprowadzić własne. ( Koniecznie zapamiętaj !)<br />
    Region: **europe-central2(Warsaw)**<br />
    Dostępność strefowa: **Jedna strefa**<br />
    Po wypełnieniu naciśnij:  **Utwórz instację** <br />

- Po utworzeniu bazy konieczne będzie dodanie Cloud Shell do "white list" 
W tym celu otwórz Cloud Shell. <br /><br />
	Dodaj do zmiennej wygenerowane wczęsniej hasło:<br />
	`export PASS={wygenerowane hasło}`
	<br /><br />
	Ustal CIDR twojej sieci, gdzie znajduje się CloudShell używając komendy:<br />
	`export ADDRESS=$(wget -qO - http://ipecho.net/plain)/32`
	<br /><br />
	Upewnić się, że wyświeli się poprawny adres IP:<br />
	`echo $ADDRESS`


- Następnie zaczekaj, aż instacja bazy danych będzie gotowa!<br /><br />
	Dodaj do autoryzowanych sieci twój zapisany CIDR, komenda:<br />
	`gcloud sql instances patch flights --authorized-networks $ADDRESS`<br /><br />
	Znajdź publiczny adres twojej instancji w konsoli GCP lub używając komendy:<br />
	`gcloud sql instances describe flights`<br /><br />
	Zapisz wartość do zmiennej:<br />
	`export DBIP={public IP}`<br />


# 2. Zasilenie bazy danymi 

- Sklonuj repozytorium - `git clone https://github.com/GoogleCloudPlatform/data-science-on-gcp`<br/> #TODO FORK
W Cloud Shell otwórz edytor (**Open Editor**) i sprawdź pobrane pliki, następnie ponownie wróć do Terminala.

- Utworzenie bazy i struktury. Wykonaj poniższe polecenia.

 	1.`cd data-science-on-gcp/03_sqlstudio`<br/>
 	2. `psql --host=$DBIP --port=5432 --user=postgres < create_table.sql`  - podłączenie do bazy i utworzenie tabeli flights.<br/>
	3. `psql --host=$DBIP --port=5432 --user=postgres` - podłączenie do bazy.<br/>
	4. `SELECT datname FROM pg_database;` - wyświetlenie dostępnych baz danych.<br/>
	5. `\c postgres` - wybierz bazę postgres i ponownie podaj hasło.<br/>
	6.`SELECT table_name
	FROM information_schema.tables
	WHERE table_schema = 'public'
	ORDER BY table_name;`<br /> - użyj zapytania do wyświetlenia wszytkich tabel.<br/> Możesz ten sam efekt osiągnąć używając komendy postgesql `\dt`.
	7. CTRL+Z - wyjdź z postgresql.<br />


- Twoja tabela jest w bazie danych, czas zasilić ją zasilić. Przygotuj dane "raw".<br />


	1.Utworz nowy bucket, lub skorzystać z istniejącego.<br />
	2. Przejść do folderu "02_ingest" (`cd ../..`, `cd 02_ingest`)<br />
	3. `bash ingest_from_crsbucket.sh {nazwa bucketu}` (nazwa bucketu bez `gs://`)<br />
	4. Przygotowanie danych "silver" <br />
	5. `cd ..`, `cd 03_sqlstudio` i `ls` dla potwierdzenia <br />
	6. `bash populate_table.sh {nazwa bucketu}`<br />
	7. Skrypt zapyta o podanie hasła.<br />
	8. Sprawdzenie, z ilu dni mamy dane: <br /><br />
			`psql --host=$DBIP --port=5432 --user=postgres` (w Cloud Shell strzałka w górę na klawiaturze, żeby odszukać poprzednie komendy)<br />
			`\c postgres`<br />
			`select DISTINCT(FL_DATE) from flights;`<br />


# 3. Symulacja awarii
1. Wejść w szczegóły bazy danych i zobaczyć "Located in..."
2. **Failower**
3. Wywoływać testowe zapytania do bazy (`select...`)
4. Po chwili baza przełączy się i wróci łączność
5. Zweryfikować w UI, czy "Located in..." zmieniło wartość


# 4. Backup i replikacja
Live demo
1. Stworzenie backup
2. Clone
3. Read replica


# Sprzątanie
1. Usunąć
	1. clone 
	2. replikę
2. Zatrzymać SQL
