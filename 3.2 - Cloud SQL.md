# 1. Utworzenie Cloud MySQL

A) W celu utworzenia CloudSQL wpisz w wyszukiwarkę GCP frazę *"SQL"*. 
Powinieneś otrzymać **Usługa SQL**, następnie wybierz ją.

B) W kolejnym kroku zobaczysz ekran powitalny, poprostu wybierz **UTWÓRZ INSTANCJĘ**.

C) Poterm z dostępnych mechanizmów baz danych wybierz **PostgreSQL**.

D) W formularzu **Tworzenia instancji PostgreSQL** wprowadź dane z poniższego wzoru:

Instance ID: **flights**
Password: **Generate** lub wprowadzić własne. ( Koniecznie zapamiętaj !)
Region: **europe-central2(Warsaw)**
Dostępność strefowa: **Jedna strefa**
Po wypełnieniu naciśnij  **Utwórz instację** 


E) Po utworzeniu bazy konieczne będzie dodanie Cloud Shell do "white list"
W tym celu otwórz Cloud Shell.

Dodaj do zmiennej wygenerowane wczęsniej hasło: 
`export PASS={wygenerowane hasło}`

Ustal CIDR twojej sieci, gdzie znajduje się CloudShell używając komendy:
`export ADDRESS=$(wget -qO - http://ipecho.net/plain)/32`

Upewnić się, że wyświeli się poprawny adres IP
`echo $ADDRESS`

**Następnie zaczekaj, aż instacja bazy danych będzie gotowa!**

Dodaj do autoryzowanych sieci twój zapisany CIDR, komenda:
`gcloud sql instances patch flights --authorized-networks $ADDRESS`

Znajdź publiczny adres twojej instancji w konsoli GCP lub używając komendy:
`gcloud sql instances describe flights`

Zapisz wartość do zmiennej: 
`export DBIP={skopiowany adres}`


# 2. Zasilenie bazy danymi 
1. `git clone https://github.com/GoogleCloudPlatform/data-science-on-gcp` (pobranie źródłowych danych)
2. W Cloud Shell otwórz edytor (**Open Editor**) i sprawdź pobrane pliki
3. Utworzenie bazy i struktury
	1. `cd data-science-on-gcp/03_sqlstudio`
	2. `mysql --host=$MYSQLIP --user=root --password=$PASS < create_table.sql`  - podłączenie do bazy i utworzenie tabeli
	3. `mysql --host=$MYSQLIP --user=root --password=$PASS` - podłączenie do bazy
	4. `use bts` - wybranie bazy
	5. `describe flights;` - wyświetlenie tabel (potwierdzić, że istnieją)
	6. `exit`
4. Przygotowanie danych "raw"
	1. Utworzyć nowy bucket, lub skorzystać z istniejącego
	2.  Przejść do folderu "02_ingest" (`cd ../..`, `cd 02_ingest`)
	4. `bash ingest_from_crsbucket.sh {nazwa bucketu}` (nazwa bucketu bez `gs://`)
5. Przygotowanie danych "silver"
	1. `cd ..`, `cd 03_sqlstudio` i `ls` dla potwierdzenia
	2. `bash populate_table.sh {nazwa bucketu}`
	3. Skrypt zapyta o podanie hasła
	4. Sprawdzenie, z ilu dni mamy dane
		1. `mysql --host=$MYSQLIP --user=root --password=$PASS` (w Cloud Shell strzałka w górę na klawiaturze, żeby odszukać poprzednie komendy)
		2. `use bts;`
		3. `select DISTINCT(FL_DATE) from flights;`


# 3. Symulacja awarii
1. Wejść w szczegóły bazy danych i zobaczyć "Located in..."
2. **Failower**
3. Wywoływać testowe zapytania do bazy (`select...`)
4. Po chwili baza przełączy się i wróci łączność
5. Zweryfikować w UI, czy "Located in..." zmieniło wartość


# 4. Backup i replikacja
Live demo
1. Stworzenie backup
2. Clone
3. Read replica


# Sprzątanie
1. Usunąć
	1. clone 
	2. replikę
2. Zatrzymać SQL
